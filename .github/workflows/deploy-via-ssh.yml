name: Deploy via SSH (from artifacts)

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'CI run id that produced artifacts (optional)'
        required: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts (manual step: replace run and artifact names if needed)
        uses: actions/download-artifact@v4
        with:
          name: docker-images
          path: ./artifacts

      - name: Prepare SSH key
        env:
          SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
        run: |
          mkdir -p /tmp/deploy
          printf '%s\n' "$SSH_KEY" > /tmp/deploy/deploy_key
          chmod 600 /tmp/deploy/deploy_key

      - name: Add known hosts (optional)
        if: ${{ secrets.DEPLOY_KNOWN_HOSTS != '' }}
        env:
          KNOWN_HOSTS: ${{ secrets.DEPLOY_KNOWN_HOSTS }}
        run: |
          mkdir -p /tmp/deploy
          printf '%s\n' "$KNOWN_HOSTS" > /tmp/deploy/known_hosts
          chmod 644 /tmp/deploy/known_hosts

      - name: Deploy artifacts to remote host
        env:
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          REMOTE_DIR: ${{ secrets.DEPLOY_DIR }}
        run: |
          if [ -f /tmp/deploy/known_hosts ]; then
            SSH_KNOWN_HOSTS_ARG="-o UserKnownHostsFile=/tmp/deploy/known_hosts -o StrictHostKeyChecking=yes"
          else
            SSH_KNOWN_HOSTS_ARG="-o StrictHostKeyChecking=no"
          fi
          scp $SSH_KNOWN_HOSTS_ARG -i /tmp/deploy/deploy_key ./artifacts/backend-image.tar $REMOTE_HOST:$REMOTE_DIR/
          scp $SSH_KNOWN_HOSTS_ARG -i /tmp/deploy/deploy_key ./artifacts/frontend-image.tar $REMOTE_HOST:$REMOTE_DIR/
          ssh $SSH_KNOWN_HOSTS_ARG -i /tmp/deploy/deploy_key $REMOTE_HOST "cd $REMOTE_DIR && docker load -i backend-image.tar && docker load -i frontend-image.tar && docker compose up -d --remove-orphans"
